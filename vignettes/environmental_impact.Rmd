---
title: "Environmental Impacts"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Environmental Impacts}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setupknitr, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
load(system.file(
  file.path("extdata", "environmental_impact_vignette.rda"),
  package = "iotables"
))
```

```{r setup, echo=FALSE, message=FALSE}
library(iotables)
library(dplyr, quietly = TRUE)
library(tidyr, quietly = TRUE)
```

In this example, we show which economic activities contribute most to greenhouse gas emissions in Belgium. We want to know how much an additional unit of production increases the CO₂-equivalent of various greenhouse gases, including methane (CH₄), nitrous oxide (N₂O), and fluorinated gases (e.g., chlorofluorocarbons, hydrochlorofluorocarbons, and halons).

While CO₂ is emitted in the greatest quantity, it is not the only culprit for global warming, and fluorinated gases have a particularly high potential to increase the greenhouse effect; therefore, in this example, we will work with the combined CO₂-equivalent effect of all greenhouse gases, abbreviated with `GHG`.

## Importing the data

The following expression will import the symmetric input-output table for Belgium (product-by-product, ESA 2010 transmission `naio_10_cp1700`). The \`stk_flow = "TOTAL"\`\`makes clear that we are not only considering effects in the domestic (Belgian) economy, but imports, too, because TOTAL covers both domestic and imported intermediate and final uses (ESA 2010 code TOTAL = DOM + IMP)

More about importing and working with matrices can be found in the articles ([Introduction to iotables](https://iotables.dataobservatory.eu/articles/intro.html), [Working with Eurostat Data](https://iotables.dataobservatory.eu/articles/working_with_eurostat.html).)

```{r getiotable, eval=FALSE}
# For faster building this data can be loaded from "../extdata/environmental_impact_vignette.rda"
BE <- iotable_get(
  source = "naio_10_cp1700",
  geo = "BE",
  year = 2020,
  labelling = "short",
  unit = "MIO_EUR",
  stk_flow = "TOTAL"
)
```

The following expression gets the the greenhouse gas emissions in CO₂ CO₂ equivalent thousand tons for Belgium in 2020. Under the hood, we download the air emissions accounts from the Eurostat data warehouse. Air Emissions Accounts (AEA), an official satellite account compiled according to the SEEA-CF (*System of Environmental-Economic Accounting 2012: Central Framework*), present data on air emissions in a way that is fully compatible with the concepts, principles and data of the national accounts, but needs further adjustment to input-output tables, which is accomplished by `airpol_get()`

```{r getairpol, eval=FALSE}
# For faster building this data has been loaded from "../extdata/environmental_impact_vignette.rda"
ghg <- airpol_get(
  airpol = "GHG",
  geo = "BE",
  year = 2020,
  unit = "THS_T"
)
```

See `?airpol_get` for the type of air pollutants that you can add to a European standard SIOT. In this case, we will first use the calculated CO₂-equivalent of mix of gases. We are calculating in thousands of tons in this case (`unit="THS_T"`).

Because we work with the `naio_10_cp1700` matrix, which is derived from product x product sources, the industry names of the SIOT start with `CPA`.

```{r siotnames}
names(BE)[1:3]
```

The AEA uses NACE Rev. 2 (industry basis):

```{r ghgnames}
names(ghg)[1:3]
```

The following utility will adjust the supplementary data. This corresponds to the bridge matrix (B) defined in Eurostat Manual §15.4.2 that is used to transform industry-based extensions to product-based form.

You do not need to make this step if you work with `naio_10_cp1750` SIOT data, which is estimated from industry x industry sources, and it uses NACE-like abbreviations.

```{r convertocpa}
ghg_prod <- convert_industry_to_product(ghg)
names(ghg_prod)[1:3]
```

## Direct and multiplied effects

The direct effects will show how many thousand tons of extra greenhouse gases will be emitted per million euros of output at basic prices (t CO₂-eq / million €) from Belgium's industries. We are adding with `supplementary_add()`—which wraps `rows_add()`—the greenhouse gas vector in a conforming form to inter-industry matrix of Belgium. We will only print the top five emitters.

```{r ghgindicators}
be_io <- BE %>%
  supplementary_add(ghg_prod)

ghg_indicator <- input_indicator_create(
  data_table = be_io,
  input_row  = "GHG_emission"
)
```

The greenhouse gas intensity indicator (direct emissions per unit of output):

```{r ghgindicator}
# Only the top 5 is printed, rename, arrange and top_n are tidyverse functions:
ghg_indicator %>%
  vector_transpose_longer(.keep = TRUE) %>%
  rename(GHG_emission_indicator = .data$value) %>%
  arrange(-.data$GHG_emission_indicator) %>%
  top_n(5)
```

In Belgium (based on the 2020 structure of the economy and considering 2020 emission levels) the most greenhouse gas intensive sectors are the usual suspects, but with a bit surprising top emitter.

| NACE code | Activity |
|:----------------------------|:-----------------------------------------:|
| A03 | Fishing and aquaculture |
| A01 | Crop and animal production, hunting and related service activities |
| H51 | Air transport |
| C23 | Manufacture of other non-metallic mineral products |
| D | Electricity, gas, steam and air conditioning supply |

This indicator shows only the direct greenhouse-gas emissions (CO₂, CH₄, N₂O and fluorinated gases) generated by each economic activity itself. It does not yet include the indirect emissions that occur along the value chain — the upstream supplier industries that provide intermediate inputs (backward linkages) or the downstream users that purchase and transform the outputs (forward linkages).

To capture the full environmental impact of final demand, these indirect effects are estimated using the Leontief inverse, which traces how additional demand for one product propagates through all interconnected industries.

The category *Manufacture of other non-metallic mineral products* requires some clarification. It covers a range of activities transforming mined or quarried non-metallic minerals — such as sand, gravel, stone, clay and refractory materials — by grinding, mixing, cutting, shaping or firing them into products for intermediate or final use. In practice, these are largely construction-related materials, so this sector reflects the environmental footprint of the building-products supply chain.

Let's make a reality check, and calculate only with CO₂:

```{r getco2indicators, eval=FALSE}
co2 <- airpol_get(
  airpol = "CO2",
  geo = "BE",
  year = 2020,
  unit = "THS_T"
)
```

```{r co2indicators}
be_io_c <- BE %>%
  supplementary_add(
    co2 %>% convert_industry_to_product()
  )

co2_indicator <- input_indicator_create(
  data_table  = be_io_c,
  input_row   = "CO2_emission"
)

# Only the top 5 is printed:
co2_indicator %>%
  vector_transpose_longer(.keep = TRUE) %>%
  rename(CO2_emission_indicator = .data$value) %>%
  arrange(-.data$CO2_emission_indicator) %>%
  top_n(5)
```

*Crop and animal production, hunting and related service activities* falls out, and *CPA_H50 Water transport* comes back. Are those barges really so clean? And what happened with the agriculture?

Let's check methane, which is a far more potent green house gas than CO₂.

```{r getmethaneindicators, eval=FALSE}
methane <- airpol_get(
  airpol = "CH4",
  geo = "BE",
  year = 2020,
  unit = "THS_T"
)
```

```{r methaneindicators}
be_io_m <- BE %>%
  supplementary_add(
    methane %>% convert_industry_to_product()
  )

methane_indicator <- input_indicator_create(
  data_table = be_io_m,
  input_row  = "CH4_emission"
)

# Only the top 5 is printed:
methane_indicator %>%
  vector_transpose_longer(.keep = TRUE) %>%
  rename(CH4_emission_indicator = .data$value) %>%
  arrange(-.data$CH4_emission_indicator) %>%
  top_n(5)
```

| NACE code | Activity |
|:----------------------------|:-----------------------------------------:|
| A01 | Crop and animal production, hunting and related service activities |
| E37-39 | Sewerage, waste management, remediation activities |
| D | Electricity, gas, steam and air conditioning supply |
| B | Mining and quarrying |
| A02 | Forestry and logging |

The appearance of *Mining and quarrying* is important, because it is the main input for the *Manufacture of other non-metallic mineral products*. Their effect may or may not be combined *in Belgium*, because the Belgian manufacturers can import mined or quarried products, too.

## Total effects

The multiplier considers these indirect effects, too. The top five polluters remain the same, but their ordering changes. *Crop and animal production, hunting and related service activities* goes ahead of *Fishing and aquaculture*---because methane is a more potent green house gas than CO₂. Cattle and sheep emit plenty of methane, and there are plenty of cattle and sheep in Belgium. The reason why it is important to consider these effects for each and every country, or, when possible, for regions, is that different countries produce different crops and animals. Producing poultry is far less problematic from a green house emission point of view than producing beef products.

As expected, the *Manufacture of other non-metallic mineral products* gets ahead of *Air transport* as it is highly interrelated with *Mining and quarrying*. Making building more sustainable would be a great achievement, but there is no really clear path: as we can see, *Forestry and logging* come with their problems, too.

```{r ghgmultiplier, message=FALSE, eval=FALSE}
I_be <- input_coefficient_matrix_create(
  data_table = BE,
  digits = 4
) %>%
  leontief_inverse_create()

ghg_multipliers <- multiplier_create(
  input_vector = ghg_indicator,
  Im = I_be,
  multiplier_name = "GHG_multiplier",
  digits = 4
)

# Only the top 5 is printed:
ghg_multipliers %>%
  vector_transpose_longer(.keep = TRUE) %>%
  rename(GHG_multiplier = .data$value) %>%
  arrange(-.data$GHG_multiplier) %>%
  top_n(5)
```

## Validation Summary

All analytical and extension functions used in this vignette were validated against the official numerical examples published in **Beutel (2008)**, *Eurostat Manual of Supply, Use and Input–Output Tables* (Luxembourg: Office for Official Publications of the European Communities).\
The table below lists the correspondence between each function and the reference table reproduced during package testing.

```{r validation, results='asis'}
cat(knitr::kable(
  data.frame(
    Function = c(
      "input_coefficient_matrix_create()",
      "leontief_matrix_create()",
      "leontief_inverse_create()",
      "supplementary_add()",
      "input_indicator_create()",
      "multiplier_create()"
    ),
    Concept = c(
      "Direct requirements (A)",
      "Leontief matrix (I − A)",
      "Total requirements (L = (I − A)⁻¹)",
      "Environmental extension (CO₂, CH₄)",
      "Input indicators (GVA, Compensation)",
      "Total multipliers (GVA, Employment)"
    ),
    Table = c("15.6", "15.9", "15.10", "15.13", "15.14", "15.16"),
    Page = c("485", "487", "488", "494", "498", "503–504")
  ),
  caption = "Cross-reference of package functions with Eurostat Manual (Beutel 2008)"
))
```

All functions were numerically cross-checked against the corresponding Eurostat tables within rounding tolerance (\< 1e-3), confirming that the `iotables` analytical pipeline—\
**A → (I − A) → L → extensions → indicators → multipliers**—\
faithfully reproduces the canonical Eurostat and UN SNA 2010 results.

```{r savevignettedata, eval=FALSE}
save(methane, co2, ghg, BE,
  file = here::here(
    "inst", "extdata", "environmental_impact_vignette.rda"
  )
)
```
